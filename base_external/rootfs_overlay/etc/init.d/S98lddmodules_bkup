#!/bin/sh
### BEGIN INIT INFO
# Provides:          lddmodules
# Required-Start:    $local_fs $syslog $remote_fs
# Required-Stop:     $local_fs $syslog $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Load/unload LDD example modules (scull, faulty, hello)
### END INIT INFO

case "$1" in
  start)
    echo "Loading scull module..."
    insmod /lib/modules/scull.ko || echo "Failed to load scull"
    major=$(awk '$2=="scull" {print $1}' /proc/devices)
    if [ -n "$major" ]; then
      rm -f /dev/scull[0-3]
      mknod /dev/scull0 c $major 0
      mknod /dev/scull1 c $major 1
      mknod /dev/scull2 c $major 2
      mknod /dev/scull3 c $major 3
      ln -sf scull0 /dev/scull
    fi

    echo "Loading faulty module..."
    insmod /lib/modules/faulty.ko || echo "Failed to load faulty"

    echo "Loading hello module..."
    modprobe hello || insmod /lib/modules/hello.ko || echo "Failed to load hello"
    ;;
    
  stop)
    echo "Unloading hello module..."
    rmmod hello 2>/dev/null

    echo "Unloading faulty module..."
    rmmod faulty 2>/dev/null

    echo "Unloading scull module..."
    rmmod scull 2>/dev/null
    rm -f /dev/scull /dev/scull[0-3] \
          /dev/scullpipe /dev/scullpipe[0-3] \
          /dev/scullsingle /dev/sculluid /dev/scullwuid /dev/scullpriv
    ;;
    
  restart)
    $0 stop
    $0 start
    ;;
    
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit 0

